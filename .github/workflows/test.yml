name: Test

on:
  push:
    branches: [main]
    paths-ignore:
      - 'docs/**'
      - '.claude/**'
      - '*.md'
      - '.github/ISSUE_TEMPLATE/**'
  pull_request:
    branches: [main]
    paths-ignore:
      - 'docs/**'
      - '.claude/**'
      - '*.md'
      - '.github/ISSUE_TEMPLATE/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Detect which files changed to conditionally run jobs
  changes:
    runs-on: ubuntu-latest
    outputs:
      code: ${{ steps.filter.outputs.code }}
    steps:
      - uses: actions/checkout@v6
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            code:
              - 'src/**'
              - '!src/**/*.md'
              - 'tests/**'
              - '!tests/**/*.md'
              - '**/*.csproj'
              - '*.sln'
              - 'Directory.Build.props'
              - '.github/workflows/**'

  test:
    needs: changes
    if: needs.changes.outputs.code == 'true'
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0  # Required for MinVer to read git history

    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: |
          8.0.x
          9.0.x
          10.0.x

    - name: Restore dependencies
      run: dotnet restore

    - name: Build
      run: dotnet build --configuration Release --no-restore

    - name: Test with Coverage
      run: |
        dotnet test --configuration Release --no-build --verbosity normal --filter "Category!=Integration" --collect:"XPlat Code Coverage" --results-directory ./coverage

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v5
      with:
        directory: ./coverage
        flags: unittests
        fail_ci_if_error: false  # Don't fail build if upload fails
        verbose: true

  # Gate job for branch protection - always runs, reports success when test passes or is skipped
  test-status:
    runs-on: ubuntu-latest
    needs: [changes, test]
    if: always()
    steps:
      - name: Check test status
        run: |
          if [[ "${{ needs.changes.outputs.code }}" != "true" ]]; then
            echo "No code changes - test skipped (OK)"
            exit 0
          elif [[ "${{ needs.test.result }}" == "success" ]]; then
            echo "Tests passed"
            exit 0
          else
            echo "Tests failed: ${{ needs.test.result }}"
            exit 1
          fi
